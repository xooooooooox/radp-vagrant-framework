desc: Establish SSH trust between guest and a specified external target
defaults:
  privileged: false
  run: once
  env:
    required: []
    optional:
      # Target identification
      - name: TARGET_HOST
        value: ""
        desc: Target hostname or IP address
      - name: TARGET_SSH_PORT
        value: ""
        desc: SSH port on the target
      - name: TARGET_SSH_USER
        value: ""
        desc: "Username on the target (default: current guest user being configured)"
      - name: TARGET_SSH_CONFIG
        value: "true"
        desc: "Write SSH config entry for the target (default: true)"
      - name: TARGET_HOST_ALIAS
        value: ""
        desc: "Host alias for SSH config entry (default: TARGET_HOST)"

      # Outbound: guest -> target
      - name: TARGET_SSH_PRIVATE_KEY_FILE
        value: ""
        desc: Path to private key file for authenticating to the target
      - name: TARGET_KEY_NAME
        value: ""
        desc: "Custom key name in ~/.ssh/ (default: id_target_{sanitized_host})"

      # Known hosts handling (choose one)
      - name: TARGET_HOST_KEY
        value: ""
        desc: Target host key content for known_hosts
      - name: TARGET_HOST_KEY_FILE
        value: ""
        desc: Path to file containing target host key(s) for known_hosts
      - name: TARGET_KEYSCAN
        value: "false"
        desc: "Attempt ssh-keyscan to fetch target host keys (graceful on failure)"

      # Inbound: target -> guest
      - name: TARGET_PUBLIC_KEY
        value: ""
        desc: "Target's SSH public key content (for authorized_keys)"
      - name: TARGET_PUBLIC_KEY_FILE
        value: ""
        desc: "Path to file containing target's SSH public key (for authorized_keys)"

      # SSH key exchange via SSH
      - name: COPY_IDENTITY_TO_TARGET
        value: "false"
        desc: "Push guest's pubkey to target's authorized_keys via SSH"
      - name: COPY_IDENTITY_FROM_TARGET
        value: "false"
        desc: "Fetch target's pubkeys to guest's authorized_keys via SSH"
      - name: TARGET_SSH_BOOTSTRAP_KEY
        value: ""
        desc: "Path to a different private key for SSH to target (default: TARGET_SSH_PRIVATE_KEY_FILE)"
      - name: TARGET_SSH_PASSWORD
        value: ""
        desc: "Password for SSH to target (used with sshpass, for first-time setup)"
      - name: TARGET_SSH_PASSWORD_FILE
        value: ""
        desc: "Path to file containing SSH password"

      # General
      - name: SSH_USERS
        value: vagrant
        desc: Comma-separated list of users to configure
  script: target-trust.sh
