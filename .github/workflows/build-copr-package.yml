name: Build COPR package

on:
  workflow_run:
    workflows:
      - Update spec version
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-copr-package:
    if: >-
      ${{
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'workflow_run' &&
         github.event.workflow_run.conclusion == 'success' &&
         (github.event.workflow_run.head_branch == 'main' ||
          startsWith(github.event.workflow_run.head_branch, 'workflow/')))
      }}
    runs-on: ubuntu-latest
    env:
      COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
      COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
      COPR_USERNAME: ${{ secrets.COPR_USERNAME }}
      COPR_PROJECT: ${{ secrets.COPR_PROJECT }}
    steps:
      - name: Validate COPR secrets
        run: |
          set -euo pipefail
          for value in COPR_LOGIN COPR_TOKEN COPR_USERNAME COPR_PROJECT; do
            if [[ -z "${!value:-}" ]]; then
              echo "Missing required secret: ${value}" >&2
              exit 1
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version
        id: version
        run: |
          set -euo pipefail
          version_file="src/main/ruby/lib/radp_vagrant/version.rb"
          version="$(grep -oE "VERSION = 'v[0-9]+\.[0-9]+\.[0-9]+'" "${version_file}" | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+" | head -n 1)"
          if [[ -z "$version" ]]; then
            echo "Failed to read VERSION from $version_file" >&2
            exit 1
          fi
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Check tag exists
        id: tag
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"
          git fetch --tags --force
          if ! git rev-parse "$version" >/dev/null 2>&1; then
            echo "Tag $version does not exist. Skipping COPR build."
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          tag_sha="$(git rev-parse "$version^{commit}")"
          run_sha="${{ github.event.workflow_run.head_sha }}"
          if [[ -n "${run_sha}" && "${tag_sha}" != "${run_sha}" ]]; then
            echo "Tag ${version} points to ${tag_sha}, workflow head is ${run_sha}; skipping COPR build."
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "should_build=true" >> "$GITHUB_OUTPUT"
          echo "tag_sha=${tag_sha}" >> "$GITHUB_OUTPUT"

      - name: Install copr-cli
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install copr-cli

      - name: Configure copr-cli
        run: |
          set -euo pipefail
          mkdir -p ~/.config
          cat <<CONFIG > ~/.config/copr
          [copr-cli]
          login = ${COPR_LOGIN}
          token = ${COPR_TOKEN}
          username = ${COPR_USERNAME}
          copr_url = https://copr.fedorainfracloud.org
          encrypted = false

          [main]
          login = ${COPR_LOGIN}
          token = ${COPR_TOKEN}
          username = ${COPR_USERNAME}
          copr_url = https://copr.fedorainfracloud.org
          encrypted = false
          CONFIG

      - name: Trigger COPR build
        if: steps.tag.outputs.should_build == 'true'
        run: |
          set -euo pipefail
          copr-cli buildscm "${COPR_PROJECT}" \
            --clone-url "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}.git" \
            --commit "${{ steps.tag.outputs.tag_sha }}" \
            --subdir "packaging/copr" \
            --spec "radp-vagrant-framework.spec"
