name: Update spec version

on:
  workflow_run:
    workflows:
      - Create version tag
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update-spec-version:
    if: >-
      ${{
        github.event_name != 'workflow_run' ||
        (github.event.workflow_run.conclusion == 'success' &&
        (github.event.workflow_run.head_branch == 'main' ||
         startsWith(github.event.workflow_run.head_branch, 'workflow/')))
      }}
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Read and validate version
        id: version
        run: |
          set -euo pipefail
          version_file="src/main/ruby/lib/radp_vagrant/version.rb"
          version="$(grep -oE "VERSION = 'v[0-9]+\.[0-9]+\.[0-9]+'" "${version_file}" | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+" | head -n 1)"
          if [[ -z "$version" ]]; then
            echo "Failed to read VERSION from $version_file" >&2
            exit 1
          fi
          if [[ ! "$version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version '$version' does not match vx.y.z" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Resolved version: $version"

      - name: Verify spec versions
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"
          version_no_prefix="${version#v}"

          # Check COPR spec
          copr_spec_file="packaging/copr/radp-vagrant-framework.spec"
          if [[ -f "$copr_spec_file" ]]; then
            copr_version="$(grep -E '^Version:' "$copr_spec_file" | awk '{print $2}')"
            if [[ "$copr_version" == "$version_no_prefix" ]]; then
              echo "COPR spec version is correct: $copr_version"
            else
              echo "WARNING: COPR spec version mismatch: expected $version_no_prefix, got $copr_version" >&2
            fi
          else
            echo "COPR spec file not found: $copr_spec_file" >&2
          fi

          # Check OBS spec
          obs_spec_file="packaging/obs/radp-vagrant-framework.spec"
          if [[ -f "$obs_spec_file" ]]; then
            obs_version="$(grep -E '^Version:' "$obs_spec_file" | awk '{print $2}')"
            if [[ "$obs_version" == "$version_no_prefix" ]]; then
              echo "OBS spec version is correct: $obs_version"
            else
              echo "WARNING: OBS spec version mismatch: expected $version_no_prefix, got $obs_version" >&2
            fi
          else
            echo "OBS spec file not found: $obs_spec_file" >&2
          fi

          echo "Spec version verification complete."
